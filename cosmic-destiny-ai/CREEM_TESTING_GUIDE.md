# Creem æ”¯ä»˜é›†æˆæµ‹è¯•æŒ‡å—

## ğŸ§ª æµ‹è¯•å‰å‡†å¤‡

### 1. ç¯å¢ƒé…ç½®

ç¡®ä¿ä½ å·²ç»é…ç½®äº†æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡ï¼š

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp env.example .env.local

# ç¼–è¾‘ .env.local å¹¶å¡«å…¥ä½ çš„å‡­è¯
# CREEM_API_KEY_TEST=creem_test_xxxxx
# CREEM_PRODUCT_ID=prod_xxxxx
# CREEM_MODE=test
```

### 2. æ•°æ®åº“è¿ç§»

è¿è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬ï¼š

```sql
-- åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ
-- è¿è¡Œæ–‡ä»¶: supabase/migrations/005_add_creem_payment_fields.sql
```

æˆ–è€…ä½¿ç”¨ Supabase CLIï¼š

```bash
supabase db push
```

### 3. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
npm install
npm run dev
```

åº”ç”¨å°†åœ¨ http://localhost:3000 è¿è¡Œã€‚

## ğŸ”§ æœ¬åœ°æµ‹è¯•ï¼ˆä½¿ç”¨ ngrokï¼‰

### 1. å®‰è£…å¹¶å¯åŠ¨ ngrok

```bash
# å®‰è£… ngrok (å¦‚æœè¿˜æ²¡æœ‰)
npm install -g ngrok

# åœ¨æ–°ç»ˆç«¯çª—å£ä¸­å¯åŠ¨ ngrok
ngrok http 3000
```

ä½ ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„è¾“å‡ºï¼š

```
Forwarding  https://1234-abc-def.ngrok.io -> http://localhost:3000
```

### 2. é…ç½® Creem Webhook

1. è®¿é—® [Creem Dashboard - Developers](https://creem.io/dashboard/developers)
2. åœ¨ "Test Webhooks" éƒ¨åˆ†æ·»åŠ ï¼š
   ```
   https://your-ngrok-url.ngrok.io/api/payments/webhook
   ```
3. ä¿å­˜é…ç½®

### 3. æµ‹è¯• Webhook è¿æ¥

åœ¨ Creem Dashboard ä¸­ç‚¹å‡» "Test Webhook" æŒ‰é’®ï¼Œä½ åº”è¯¥èƒ½åœ¨ç»ˆç«¯çœ‹åˆ°æ—¥å¿—è¾“å‡ºã€‚

## ğŸ¯ æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: å®Œæ•´æ”¯ä»˜æµç¨‹

#### æ­¥éª¤ï¼š

1. **ç™»å½•åº”ç”¨**
   ```
   è®¿é—®: http://localhost:3000/auth
   åˆ›å»ºæµ‹è¯•è´¦æˆ·æˆ–ç™»å½•
   ```

2. **ç”Ÿæˆé¢„è§ˆæŠ¥å‘Š**
   ```
   è®¿é—®: http://localhost:3000/generate
   å¡«å†™å‡ºç”Ÿä¿¡æ¯å¹¶æäº¤
   ç­‰å¾…é¢„è§ˆæŠ¥å‘Šç”Ÿæˆ
   ```

3. **æŸ¥çœ‹ Dashboard**
   ```
   è®¿é—®: http://localhost:3000/dashboard
   åº”è¯¥çœ‹åˆ°ä½ çš„æŠ¥å‘Šï¼ŒçŠ¶æ€ä¸º"æœªè§£é”"
   ```

4. **è§¦å‘æ”¯ä»˜æµç¨‹**
   ```
   ç‚¹å‡»æŠ¥å‘Šä¸Šçš„"è§£é”å®Œæ•´æŠ¥å‘Š"æŒ‰é’®
   åº”è¯¥è·³è½¬åˆ° Creem æ”¯ä»˜é¡µé¢
   ```

5. **å®Œæˆæ”¯ä»˜**
   ```
   åœ¨ Creem é¡µé¢å®Œæˆæµ‹è¯•æ”¯ä»˜
   ï¼ˆæµ‹è¯•æ¨¡å¼ä¸‹å¯èƒ½æœ‰ç‰¹æ®Šçš„æ”¯ä»˜æ–¹å¼ï¼‰
   ```

6. **éªŒè¯è¿”å›**
   ```
   åº”è¯¥è‡ªåŠ¨è·³è½¬å›: /payment/success
   çœ‹åˆ°æ”¯ä»˜æˆåŠŸé¡µé¢
   ```

7. **æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š**
   ```
   ç‚¹å‡»"æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š"
   åº”è¯¥èƒ½çœ‹åˆ°å®Œæ•´çš„å‘½ç†åˆ†æ
   ```

#### é¢„æœŸç»“æœï¼š

âœ… ç”¨æˆ·å¯ä»¥çœ‹åˆ°å®Œæ•´æŠ¥å‘Š  
âœ… æŠ¥å‘Šæ ‡è®°ä¸ºå·²ä»˜è´¹  
âœ… æ•°æ®åº“ä¸­æœ‰æ”¯ä»˜è®°å½•  
âœ… æ”¯ä»˜çŠ¶æ€ä¸º 'completed'

### åœºæ™¯ 2: å–æ¶ˆæ”¯ä»˜

#### æ­¥éª¤ï¼š

1. æŒ‰ç…§åœºæ™¯ 1 çš„æ­¥éª¤ 1-4 æ“ä½œ
2. åœ¨ Creem æ”¯ä»˜é¡µé¢ç‚¹å‡»"å–æ¶ˆ"æˆ–å…³é—­çª—å£
3. åº”è¯¥è·³è½¬åˆ° `/payment/cancel`

#### é¢„æœŸç»“æœï¼š

âœ… æ˜¾ç¤ºæ”¯ä»˜å–æ¶ˆé¡µé¢  
âœ… ç”¨æˆ·å¯ä»¥è¿”å› Dashboard  
âœ… æŠ¥å‘Šä»ç„¶å¤„äºé”å®šçŠ¶æ€  
âœ… æ•°æ®åº“ä¸­æœ‰æ”¯ä»˜è®°å½•ï¼ŒçŠ¶æ€ä¸º 'pending'

### åœºæ™¯ 3: Webhook å¤„ç†

#### æ­¥éª¤ï¼š

1. åœ¨ Creem Dashboard æ‰¾åˆ°ä½ çš„æµ‹è¯•æ”¯ä»˜
2. ç‚¹å‡» "Resend Webhook"
3. æŸ¥çœ‹åº”ç”¨æ—¥å¿—

#### é¢„æœŸæ—¥å¿—ï¼š

```
[Webhook] Received webhook request
[Webhook] Event type: payment.success
[Webhook] Processing payment success: { checkout_id: '...', order_id: '...' }
[Webhook] Generating full report...
[Webhook] Full report generated successfully
[Webhook] Payment processed successfully
```

#### é¢„æœŸç»“æœï¼š

âœ… Webhook è¿”å› 200 OK  
âœ… æ”¯ä»˜çŠ¶æ€æ›´æ–°ä¸º 'completed'  
âœ… æŠ¥å‘Šæ ‡è®°ä¸ºå·²ä»˜è´¹  
âœ… å®Œæ•´æŠ¥å‘Šå·²ç”Ÿæˆ

### åœºæ™¯ 4: ç­¾åéªŒè¯

#### æµ‹è¯•æ–¹æ³•ï¼š

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
2. å®Œæˆä¸€æ¬¡æ”¯ä»˜
3. åœ¨è¿”å› URL ä¸­æ‰‹åŠ¨ä¿®æ”¹å‚æ•°ï¼ˆå¦‚ order_idï¼‰
4. è®¿é—®ä¿®æ”¹åçš„ URL

#### é¢„æœŸç»“æœï¼š

âŒ ç­¾åéªŒè¯å¤±è´¥  
âŒ æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯  
âœ… æŠ¥å‘Šä¸ä¼šè¢«è§£é”

### åœºæ™¯ 5: é‡å¤æ”¯ä»˜æ£€æµ‹

#### æ­¥éª¤ï¼š

1. å®Œæˆä¸€æ¬¡æ”¯ä»˜ï¼Œè§£é”æŠ¥å‘Š
2. å°è¯•å†æ¬¡ç‚¹å‡»"è§£é”å®Œæ•´æŠ¥å‘Š"

#### é¢„æœŸç»“æœï¼š

âœ… æŒ‰é’®æ˜¾ç¤ºä¸º"å·²è§£é”"æˆ–éšè—  
âœ… å¦‚æœå¼ºåˆ¶è¯·æ±‚ï¼ŒAPI è¿”å›é”™è¯¯  
âœ… ä¸åˆ›å»ºæ–°çš„æ”¯ä»˜è®°å½•

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹æ—¥å¿—

```bash
# åº”ç”¨æ—¥å¿—
# åœ¨è¿è¡Œ npm run dev çš„ç»ˆç«¯ä¸­æŸ¥çœ‹

# æŸ¥æ‰¾ç‰¹å®šäº‹ä»¶
# [Payment] - æ”¯ä»˜ç›¸å…³æ—¥å¿—
# [Webhook] - Webhook å¤„ç†æ—¥å¿—
# [Creem] - Creem API è°ƒç”¨æ—¥å¿—
```

### æ£€æŸ¥æ•°æ®åº“

```sql
-- æŸ¥çœ‹æ‰€æœ‰æ”¯ä»˜è®°å½•
SELECT * FROM payments ORDER BY created_at DESC;

-- æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„æ”¯ä»˜
SELECT p.*, ur.name, ur.is_paid 
FROM payments p
JOIN user_reports ur ON p.report_id = ur.id
WHERE p.user_id = 'your-user-id';

-- æŸ¥çœ‹å¾…å¤„ç†çš„æ”¯ä»˜
SELECT * FROM payments WHERE status = 'pending';

-- æŸ¥çœ‹æœ€è¿‘çš„ webhook äº‹ä»¶
SELECT * FROM payments WHERE updated_at > NOW() - INTERVAL '1 hour';
```

### æµ‹è¯• API ç«¯ç‚¹

```bash
# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:3000/api/health

# æµ‹è¯•åˆ›å»º checkoutï¼ˆéœ€è¦è®¤è¯ tokenï¼‰
curl -X POST http://localhost:3000/api/payments/create-checkout \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{"reportId": "report-id-here"}'

# æµ‹è¯•æ”¯ä»˜éªŒè¯
curl http://localhost:3000/api/payments/verify?checkout_id=ch_xxxxx \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### ä½¿ç”¨ Creem Dashboard

1. **æŸ¥çœ‹æ”¯ä»˜**
   - Dashboard > Payments
   - æŸ¥çœ‹æ‰€æœ‰æµ‹è¯•æ”¯ä»˜è®°å½•

2. **æŸ¥çœ‹ Webhook æ—¥å¿—**
   - Dashboard > Developers > Webhooks
   - æŸ¥çœ‹æ¯ä¸ª webhook çš„è¯·æ±‚å’Œå“åº”

3. **é‡æ–°å‘é€ Webhook**
   - åœ¨æ”¯ä»˜è¯¦æƒ…ä¸­ç‚¹å‡» "Resend Webhook"
   - ç”¨äºæµ‹è¯• webhook å¤„ç†é€»è¾‘

## ğŸ“ æµ‹è¯•æ£€æŸ¥æ¸…å•

### åŠŸèƒ½æµ‹è¯•

- [ ] ç”¨æˆ·å¯ä»¥ç™»å½•/æ³¨å†Œ
- [ ] å¯ä»¥ç”Ÿæˆé¢„è§ˆæŠ¥å‘Š
- [ ] é¢„è§ˆæŠ¥å‘Šæ­£ç¡®æ˜¾ç¤º
- [ ] "è§£é”"æŒ‰é’®æ­£ç¡®æ˜¾ç¤º
- [ ] ç‚¹å‡»æŒ‰é’®è·³è½¬åˆ° Creem
- [ ] Creem é¡µé¢æ˜¾ç¤ºæ­£ç¡®çš„äº§å“ä¿¡æ¯
- [ ] å®Œæˆæ”¯ä»˜åæ­£ç¡®è¿”å›
- [ ] è¿”å›é¡µé¢æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
- [ ] å®Œæ•´æŠ¥å‘Šæ­£ç¡®ç”Ÿæˆ
- [ ] æŠ¥å‘ŠçŠ¶æ€æ›´æ–°ä¸ºå·²ä»˜è´¹
- [ ] ç”¨æˆ·å¯ä»¥æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š
- [ ] å–æ¶ˆæ”¯ä»˜æ­£ç¡®å¤„ç†
- [ ] å·²ä»˜è´¹æŠ¥å‘Šä¸èƒ½å†æ¬¡ä»˜è´¹

### Webhook æµ‹è¯•

- [ ] Webhook ç«¯ç‚¹å¯è®¿é—®
- [ ] æ¥æ”¶ payment.success äº‹ä»¶
- [ ] æ¥æ”¶ payment.failed äº‹ä»¶
- [ ] æ¥æ”¶ payment.refunded äº‹ä»¶
- [ ] ç­¾åéªŒè¯å·¥ä½œæ­£å¸¸
- [ ] å¹‚ç­‰æ€§å¤„ç†ï¼ˆé‡å¤ webhookï¼‰
- [ ] é”™è¯¯å¤„ç†æ­£ç¡®
- [ ] æ—¥å¿—è®°å½•å®Œæ•´

### å®‰å…¨æµ‹è¯•

- [ ] éœ€è¦è®¤è¯æ‰èƒ½åˆ›å»ºæ”¯ä»˜
- [ ] ç”¨æˆ·åªèƒ½ä¸ºè‡ªå·±çš„æŠ¥å‘Šä»˜è´¹
- [ ] ç­¾åéªŒè¯é˜²æ­¢ç¯¡æ”¹
- [ ] API Key ä¸æš´éœ²åœ¨å‰ç«¯
- [ ] Webhook ç­¾åéªŒè¯ï¼ˆå¦‚å¯ç”¨ï¼‰
- [ ] é˜²æ­¢é‡å¤æ”¯ä»˜
- [ ] HTTPS å¼ºåˆ¶ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

### æ•°æ®å®Œæ•´æ€§

- [ ] æ”¯ä»˜è®°å½•æ­£ç¡®åˆ›å»º
- [ ] æ”¯ä»˜çŠ¶æ€æ­£ç¡®æ›´æ–°
- [ ] æŠ¥å‘ŠçŠ¶æ€ä¸æ”¯ä»˜åŒæ­¥
- [ ] æ‰€æœ‰å­—æ®µæ­£ç¡®å¡«å……
- [ ] æ—¶é—´æˆ³æ­£ç¡®
- [ ] å…³è”å…³ç³»æ­£ç¡®

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜ 1: Webhook æ”¶ä¸åˆ°

**å¯èƒ½åŸå› ï¼š**
- ngrok æœªè¿è¡Œ
- Webhook URL é…ç½®é”™è¯¯
- é˜²ç«å¢™é˜»æ­¢

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# ç¡®è®¤ ngrok è¿è¡Œä¸­
ngrok http 3000

# æ£€æŸ¥ URL é…ç½®
# Dashboard > Developers > Webhooks

# æµ‹è¯•è¿æ¥
curl -X POST https://your-ngrok-url.ngrok.io/api/payments/webhook \
  -H "Content-Type: application/json" \
  -d '{"event":"test","data":{}}'
```

### é—®é¢˜ 2: ç­¾åéªŒè¯å¤±è´¥

**å¯èƒ½åŸå› ï¼š**
- API Key ä¸æ­£ç¡®
- å‚æ•°é¡ºåºé”™è¯¯
- ç¼–ç é—®é¢˜

**è§£å†³æ–¹æ¡ˆï¼š**
```typescript
// åœ¨ paymentService.ts ä¸­æ·»åŠ æ—¥å¿—
console.log('Verifying signature:', {
  params: sortedParams,
  signature: signature,
  expected: expectedSignature
})
```

### é—®é¢˜ 3: å®Œæ•´æŠ¥å‘Šæœªç”Ÿæˆ

**å¯èƒ½åŸå› ï¼š**
- Gemini API é”™è¯¯
- API é…é¢ç”¨å®Œ
- ç½‘ç»œé—®é¢˜

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æ£€æŸ¥ Gemini API Key
echo $GEMINI_API_KEY

# æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
# åœ¨ webhook å¤„ç†æ—¥å¿—ä¸­æŸ¥æ‰¾é”™è¯¯

# æ‰‹åŠ¨é‡è¯•
# åœ¨ Creem Dashboard ä¸­é‡æ–°å‘é€ webhook
```

### é—®é¢˜ 4: æ•°æ®åº“é”™è¯¯

**å¯èƒ½åŸå› ï¼š**
- è¿ç§»æœªè¿è¡Œ
- æƒé™é—®é¢˜
- å­—æ®µç±»å‹ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆï¼š**
```sql
-- æ£€æŸ¥è¡¨ç»“æ„
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'payments';

-- æ£€æŸ¥çº¦æŸ
SELECT constraint_name, constraint_type 
FROM information_schema.table_constraints 
WHERE table_name = 'payments';

-- é‡æ–°è¿è¡Œè¿ç§»
-- åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œè¿ç§»è„šæœ¬
```

## ğŸš€ å‡†å¤‡ä¸Šçº¿

åœ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒä¹‹å‰ï¼š

1. **åˆ‡æ¢åˆ°ç”Ÿäº§æ¨¡å¼**
   ```env
   CREEM_MODE=live
   CREEM_API_KEY=creem_live_xxxxx
   ```

2. **é…ç½®ç”Ÿäº§ Webhook**
   ```
   https://your-domain.com/api/payments/webhook
   ```

3. **è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶**
   - åœ¨ç”Ÿäº§ç¯å¢ƒå®Œæˆä¸€æ¬¡çœŸå®æµ‹è¯•
   - ä½¿ç”¨å°é¢æ”¯ä»˜è¿›è¡Œæµ‹è¯•
   - ç«‹å³é€€æ¬¾æµ‹è¯•æ”¯ä»˜

4. **å¯ç”¨ç›‘æ§**
   - é…ç½®é”™è¯¯è¿½è¸ªï¼ˆå¦‚ Sentryï¼‰
   - è®¾ç½®æ”¯ä»˜å¤±è´¥å‘Šè­¦
   - ç›‘æ§ webhook æˆåŠŸç‡

5. **å‡†å¤‡æ”¯æŒ**
   - å‡†å¤‡é€€æ¬¾æµç¨‹
   - å‡†å¤‡å®¢æœå“åº”æ¨¡æ¿
   - æµ‹è¯•é€€æ¬¾åŠŸèƒ½

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### è´Ÿè½½æµ‹è¯•

```bash
# ä½¿ç”¨ Apache Bench æµ‹è¯•
ab -n 100 -c 10 http://localhost:3000/api/health

# æµ‹è¯•æ”¯ä»˜åˆ›å»ºï¼ˆéœ€è¦è„šæœ¬ï¼‰
# åˆ›å»º 100 ä¸ªå¹¶å‘æ”¯ä»˜è¯·æ±‚
```

### å“åº”æ—¶é—´ç›‘æ§

```typescript
// åœ¨ API è·¯ç”±ä¸­æ·»åŠ æ€§èƒ½æ—¥å¿—
const startTime = Date.now()
// ... å¤„ç†é€»è¾‘
console.log(`[Performance] Request took ${Date.now() - startTime}ms`)
```

## âœ… æµ‹è¯•å®Œæˆ

å®Œæˆæ‰€æœ‰æµ‹è¯•åï¼Œä½ åº”è¯¥ç¡®è®¤ï¼š

âœ… æ‰€æœ‰æµ‹è¯•åœºæ™¯é€šè¿‡  
âœ… æ‰€æœ‰æ£€æŸ¥æ¸…å•é¡¹ç›®å®Œæˆ  
âœ… æ²¡æœ‰æœªè§£å†³çš„é”™è¯¯  
âœ… æ—¥å¿—è®°å½•å®Œæ•´  
âœ… æ–‡æ¡£å·²æ›´æ–°  
âœ… å›¢é˜Ÿå·²åŸ¹è®­  

æ­å–œï¼ä½ çš„ Creem æ”¯ä»˜é›†æˆå·²å‡†å¤‡å°±ç»ªï¼ ğŸ‰


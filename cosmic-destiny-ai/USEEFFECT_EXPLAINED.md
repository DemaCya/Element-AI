# useEffect è¶…è¯¦ç»†è§£é‡Š - ä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ

## ğŸ¬ æ²¡æœ‰ useEffect ä¼šæ€æ ·ï¼Ÿ

### âŒ é”™è¯¯ç¤ºä¾‹ 1ï¼šç›´æ¥ await

```typescript
function UserProvider({ children }) {
  const [user, setUser] = useState(null)
  
  // âŒ æŠ¥é”™ï¼šCannot use 'await' outside an async function
  const userData = await supabase.auth.getUser()
  setUser(userData)
  
  return <UserContext.Provider value={{ user }}>...</UserContext.Provider>
}
```

**é—®é¢˜**ï¼šReact ç»„ä»¶å‡½æ•°ä¸èƒ½æ˜¯ async å‡½æ•°

---

### âŒ é”™è¯¯ç¤ºä¾‹ 2ï¼šæ”¹æˆ async å‡½æ•°

```typescript
async function UserProvider({ children }) {  // âŒ ç»„ä»¶ä¸èƒ½æ˜¯ async
  const [user, setUser] = useState(null)
  
  const userData = await supabase.auth.getUser()
  setUser(userData)
  
  return <UserContext.Provider value={{ user }}>...</UserContext.Provider>
}
```

**é—®é¢˜**ï¼šReact ä¸æ”¯æŒ async ç»„ä»¶ï¼ˆç»„ä»¶å¿…é¡»ç«‹å³è¿”å› JSXï¼‰

---

### âŒ é”™è¯¯ç¤ºä¾‹ 3ï¼šç›´æ¥è°ƒç”¨å¼‚æ­¥å‡½æ•°

```typescript
function UserProvider({ children }) {
  const [user, setUser] = useState(null)
  
  // âŒ è¿™ä¼šå¯¼è‡´æ— é™å¾ªç¯ï¼
  supabase.auth.getUser().then(data => {
    setUser(data.user)  // æ”¹å˜çŠ¶æ€
  })
  // â†’ ç»„ä»¶é‡æ–°æ¸²æŸ“
  // â†’ åˆæ‰§è¡Œè¿™æ®µä»£ç 
  // â†’ åˆè°ƒç”¨ setUser()
  // â†’ åˆé‡æ–°æ¸²æŸ“
  // â†’ ğŸ’¥ æ— é™å¾ªç¯ï¼
  
  return <UserContext.Provider value={{ user }}>...</UserContext.Provider>
}
```

**é—®é¢˜**ï¼šæ¯æ¬¡æ¸²æŸ“éƒ½ä¼šè°ƒç”¨ï¼Œå¯¼è‡´æ— é™å¾ªç¯

---

## âœ… æ­£ç¡®æ–¹å¼ï¼šuseEffect

```typescript
function UserProvider({ children }) {
  const [user, setUser] = useState(null)
  
  useEffect(() => {
    // âœ… è¿™é‡Œçš„ä»£ç åªåœ¨"ç‰¹å®šæ—¶æœº"è¿è¡Œ
    async function loadUser() {
      const data = await supabase.auth.getUser()
      setUser(data.user)
    }
    loadUser()
  }, [])  // â† ç©ºæ•°ç»„ = åªåœ¨ç»„ä»¶ç¬¬ä¸€æ¬¡æ˜¾ç¤ºæ—¶è¿è¡Œ
  
  return <UserContext.Provider value={{ user }}>...</UserContext.Provider>
}
```

**ä¸ºä»€ä¹ˆå¯ä»¥ï¼Ÿ**
- useEffect åœ¨"æ¸²æŸ“ä¹‹å"è¿è¡Œ
- `[]` ä¾èµ–æ•°ç»„ç¡®ä¿åªè¿è¡Œä¸€æ¬¡
- ä¸ä¼šå¯¼è‡´æ— é™å¾ªç¯

---

## ğŸ” useEffect åœ¨æˆ‘ä»¬ä»£ç ä¸­åšäº†3ä»¶äº‹

```typescript
useEffect(() => {
  // ==========================================
  // ç¬¬1ä»¶äº‹ï¼šåŠ è½½ç”¨æˆ·æ•°æ®ï¼ˆåªè¿è¡Œä¸€æ¬¡ï¼‰
  // ==========================================
  async function loadUser() {
    // 1. ä» Supabase è·å–å½“å‰ç™»å½•ç”¨æˆ·
    const { data: { user } } = await supabase.auth.getUser()
    setUser(user)
    
    // 2. å¦‚æœæœ‰ç”¨æˆ·ï¼Œè·å–ä»–çš„è¯¦ç»†ä¿¡æ¯
    if (user) {
      const { data: profile } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', user.id)
        .single()
      
      setProfile(profile)
    }
    
    // 3. å®ŒæˆåŠ è½½
    setLoading(false)
  }
  
  loadUser()  // è°ƒç”¨å‡½æ•°ï¼Œå¼€å§‹åŠ è½½
  
  // ==========================================
  // ç¬¬2ä»¶äº‹ï¼šç›‘å¬ç”¨æˆ·ç™»å½•/ç™»å‡ºäº‹ä»¶
  // ==========================================
  const { data: { subscription } } = supabase.auth.onAuthStateChange(
    async (event, session) => {
      if (event === 'SIGNED_IN') {
        // ç”¨æˆ·ç™»å½•äº†ï¼Œæ›´æ–°çŠ¶æ€
        setUser(session.user)
        // è·å–profile...
      }
      
      if (event === 'SIGNED_OUT') {
        // ç”¨æˆ·ç™»å‡ºäº†ï¼Œæ¸…ç©ºçŠ¶æ€
        setUser(null)
        setProfile(null)
      }
    }
  )
  
  // ==========================================
  // ç¬¬3ä»¶äº‹ï¼šæ¸…ç†ï¼ˆç»„ä»¶å¸è½½æ—¶ï¼‰
  // ==========================================
  return () => {
    subscription.unsubscribe()  // å–æ¶ˆç›‘å¬
  }
  
}, [supabase])  // â† åªä¾èµ– supabaseï¼ˆå®ƒä¸ä¼šå˜ï¼‰
```

---

## ğŸ“Š å®Œæ•´æ‰§è¡Œæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1æ­¥ï¼šåº”ç”¨å¯åŠ¨                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬2æ­¥ï¼šReact æ¸²æŸ“ <UserProvider>                         â”‚
â”‚                                                          â”‚
â”‚ æ‰§è¡Œï¼š                                                   â”‚
â”‚   const [user, setUser] = useState(null)                â”‚
â”‚   const [profile, setProfile] = useState(null)          â”‚
â”‚   const [loading, setLoading] = useState(true)          â”‚
â”‚                                                          â”‚
â”‚ æ­¤æ—¶ï¼šuser=null, profile=null, loading=true             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬3æ­¥ï¼šè¿”å› JSXï¼ˆæ˜¾ç¤ºloadingçŠ¶æ€ï¼‰                        â”‚
â”‚                                                          â”‚
â”‚ return (                                                 â”‚
â”‚   <UserContext.Provider value={{ user, profile, ... }}>â”‚
â”‚     {children}  â† è¿™é‡ŒåŒ…å«æ‰€æœ‰é¡µé¢                       â”‚
â”‚   </UserContext.Provider>                               â”‚
â”‚ )                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬4æ­¥ï¼šæ¸²æŸ“å®Œæˆåï¼ŒuseEffect å¼€å§‹è¿è¡Œ ğŸ¯                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬5æ­¥ï¼šæ‰§è¡Œ loadUser()                                   â”‚
â”‚                                                          â”‚
â”‚ 1. await supabase.auth.getUser()  â† ç½‘ç»œè¯·æ±‚(~200ms)    â”‚
â”‚    ç»“æœï¼š{ user: { id: 'xxx', email: 'user@example.com' }}â”‚
â”‚                                                          â”‚
â”‚ 2. setUser(user)  â† æ›´æ–°çŠ¶æ€                             â”‚
â”‚    è§¦å‘é‡æ–°æ¸²æŸ“ï¼                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬6æ­¥ï¼šReact é‡æ–°æ¸²æŸ“ï¼ˆå› ä¸º user å˜äº†ï¼‰                   â”‚
â”‚                                                          â”‚
â”‚ æ­¤æ—¶ï¼šuser={...}, profile=null, loading=true            â”‚
â”‚                                                          â”‚
â”‚ useEffect æ£€æŸ¥ä¾èµ–ï¼š[supabase] æ²¡å˜ â†’ ä¸é‡æ–°è¿è¡Œ âœ…       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬7æ­¥ï¼šloadUser() ç»§ç»­æ‰§è¡Œ                               â”‚
â”‚                                                          â”‚
â”‚ 3. await supabase.from('profiles').select()  â† ç½‘ç»œè¯·æ±‚  â”‚
â”‚    ç»“æœï¼š{ data: { full_name: 'John', ... }}            â”‚
â”‚                                                          â”‚
â”‚ 4. setProfile(profileData)  â† æ›´æ–°çŠ¶æ€                   â”‚
â”‚    åˆè§¦å‘é‡æ–°æ¸²æŸ“ï¼                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬8æ­¥ï¼šReact å†æ¬¡é‡æ–°æ¸²æŸ“ï¼ˆå› ä¸º profile å˜äº†ï¼‰            â”‚
â”‚                                                          â”‚
â”‚ æ­¤æ—¶ï¼šuser={...}, profile={...}, loading=true           â”‚
â”‚                                                          â”‚
â”‚ useEffect æ£€æŸ¥ä¾èµ–ï¼š[supabase] æ²¡å˜ â†’ ä¸é‡æ–°è¿è¡Œ âœ…       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬9æ­¥ï¼šloadUser() å®Œæˆ                                   â”‚
â”‚                                                          â”‚
â”‚ 5. setLoading(false)  â† æ›´æ–°çŠ¶æ€                         â”‚
â”‚    æœ€åä¸€æ¬¡è§¦å‘æ¸²æŸ“ï¼                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬10æ­¥ï¼šæœ€ç»ˆæ¸²æŸ“                                          â”‚
â”‚                                                          â”‚
â”‚ æ­¤æ—¶ï¼šuser={...}, profile={...}, loading=false âœ…        â”‚
â”‚                                                          â”‚
â”‚ æ‰€æœ‰é¡µé¢ç°åœ¨å¯ä»¥ç”¨ useUser() è·å–è¿™äº›æ•°æ®ï¼               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬11æ­¥ï¼šç›‘å¬äº‹ä»¶ï¼ˆåœ¨åå°æŒç»­è¿è¡Œï¼‰                        â”‚
â”‚                                                          â”‚
â”‚ supabase.auth.onAuthStateChange æŒç»­ç›‘å¬...             â”‚
â”‚                                                          â”‚
â”‚ å¦‚æœç”¨æˆ·ç™»å½• â†’ è§¦å‘ 'SIGNED_IN' â†’ æ›´æ–° user              â”‚
â”‚ å¦‚æœç”¨æˆ·ç™»å‡º â†’ è§¦å‘ 'SIGNED_OUT' â†’ æ¸…ç©º user             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ useEffect çš„3ä¸ªæ ¸å¿ƒä½œç”¨

### 1ï¸âƒ£ åœ¨"æ­£ç¡®çš„æ—¶æœº"æ‰§è¡Œä»£ç 

```typescript
useEffect(() => {
  console.log('ç»„ä»¶æ¸²æŸ“å®Œæˆåæ‰§è¡Œ')
}, [])
```

**æ—¶æœº**ï¼š
- âœ… æ¸²æŸ“ä¹‹åï¼ˆä¸é˜»å¡æ¸²æŸ“ï¼‰
- âœ… DOM å·²ç»æ›´æ–°
- âœ… ç”¨æˆ·å¯ä»¥çœ‹åˆ°ç•Œé¢

**å¯¹æ¯”ç›´æ¥æ‰§è¡Œ**ï¼š
```typescript
// âŒ ç›´æ¥æ‰§è¡Œï¼šåœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­
console.log('è¿™ä¼šåœ¨æ¸²æŸ“æ—¶æ‰§è¡Œï¼Œå¯èƒ½é˜»å¡ç•Œé¢')

useEffect(() => {
  // âœ… useEffectï¼šåœ¨æ¸²æŸ“å®Œæˆå
  console.log('è¿™åœ¨æ¸²æŸ“å®Œæˆåæ‰§è¡Œï¼Œä¸é˜»å¡ç•Œé¢')
}, [])
```

---

### 2ï¸âƒ£ é¿å…æ— é™å¾ªç¯

```typescript
useEffect(() => {
  // è¿™é‡Œæ”¹å˜çŠ¶æ€ä¸ä¼šå¯¼è‡´æ— é™å¾ªç¯
  setUser(newUser)
}, [])  // â† ä¾èµ–æ•°ç»„æ§åˆ¶è¿è¡Œæ¬¡æ•°
```

**ä¾èµ–æ•°ç»„çš„é­”æ³•**ï¼š

| ä¾èµ–æ•°ç»„ | è¿è¡Œæ—¶æœº | ç”¨é€” |
|---------|---------|------|
| `[]` | åªè¿è¡Œä¸€æ¬¡ï¼ˆé¦–æ¬¡æ¸²æŸ“åï¼‰ | è·å–åˆå§‹æ•°æ®ã€è®¾ç½®è®¢é˜… |
| `[user]` | é¦–æ¬¡ + æ¯æ¬¡ user å˜åŒ– | æ ¹æ® user è·å–å…¶ä»–æ•°æ® |
| ä¸å†™ | æ¯æ¬¡æ¸²æŸ“éƒ½è¿è¡Œ | âŒ å¾ˆå°‘ç”¨ï¼Œå®¹æ˜“å‡ºé—®é¢˜ |

**ä¾‹å­**ï¼š
```typescript
// åœºæ™¯1ï¼šåŠ è½½ç”¨æˆ·ï¼ˆåªåŠ è½½ä¸€æ¬¡ï¼‰
useEffect(() => {
  loadUser()
}, [])  // ç©ºæ•°ç»„ = åªè¿è¡Œä¸€æ¬¡

// åœºæ™¯2ï¼šæ ¹æ®ç”¨æˆ·IDåŠ è½½æŠ¥å‘Š
useEffect(() => {
  if (user) {
    loadReports(user.id)
  }
}, [user])  // å½“ user æ”¹å˜æ—¶é‡æ–°åŠ è½½

// åœºæ™¯3ï¼šå®æ—¶æœç´¢
useEffect(() => {
  search(searchTerm)
}, [searchTerm])  // å½“æœç´¢è¯æ”¹å˜æ—¶æœç´¢
```

---

### 3ï¸âƒ£ æ¸…ç†èµ„æºï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰

```typescript
useEffect(() => {
  // è®¾ç½®ç›‘å¬
  const subscription = supabase.auth.onAuthStateChange(...)
  
  // è¿”å›æ¸…ç†å‡½æ•°
  return () => {
    subscription.unsubscribe()  // å–æ¶ˆç›‘å¬
  }
}, [])
```

**ä¸ºä»€ä¹ˆéœ€è¦æ¸…ç†ï¼Ÿ**

```
ç”¨æˆ·è¿›å…¥é¡µé¢ â†’ å¼€å§‹ç›‘å¬äº‹ä»¶ ğŸ“¡
ç”¨æˆ·ç¦»å¼€é¡µé¢ â†’ è¿˜åœ¨ç›‘å¬ï¼Ÿ âŒ å†…å­˜æ³„æ¼ï¼

æ­£ç¡®åšæ³•ï¼š
ç”¨æˆ·è¿›å…¥é¡µé¢ â†’ å¼€å§‹ç›‘å¬äº‹ä»¶ ğŸ“¡
ç”¨æˆ·ç¦»å¼€é¡µé¢ â†’ å–æ¶ˆç›‘å¬ âœ…
```

**å¸¸è§éœ€è¦æ¸…ç†çš„ä¸œè¥¿**ï¼š
- äº‹ä»¶ç›‘å¬å™¨
- å®šæ—¶å™¨ï¼ˆsetTimeout, setIntervalï¼‰
- WebSocket è¿æ¥
- æ•°æ®è®¢é˜…

---

## ğŸ“š ç±»æ¯”ï¼šç†è§£ useEffect

### ç±»æ¯”1ï¼šé¤å…ç‚¹é¤

```typescript
function Restaurant() {
  const [food, setFood] = useState(null)
  
  // âŒ é”™è¯¯ï¼šåœ¨å®¢äººè¿›é—¨æ—¶å°±å¼€å§‹åšèœï¼Ÿ
  cookFood().then(dish => setFood(dish))  // æ— é™å¾ªç¯ï¼
  
  // âœ… æ­£ç¡®ï¼šå®¢äººåä¸‹åï¼ˆæ¸²æŸ“å®Œæˆï¼‰æ‰å¼€å§‹åšèœ
  useEffect(() => {
    cookFood().then(dish => setFood(dish))
  }, [])  // åªåšä¸€æ¬¡
  
  return <div>{food ? 'èœæ¥äº†' : 'ç­‰å¾…ä¸­...'}</div>
}
```

**æµç¨‹**ï¼š
1. å®¢äººè¿›é—¨ï¼ˆç»„ä»¶æ¸²æŸ“ï¼‰
2. å…ˆåä¸‹ï¼ˆæ˜¾ç¤º"ç­‰å¾…ä¸­..."ï¼‰
3. ç„¶åç‚¹é¤åšèœï¼ˆuseEffect æ‰§è¡Œï¼‰
4. èœåšå¥½äº†ï¼ˆsetFoodï¼‰
5. ä¸Šèœï¼ˆé‡æ–°æ¸²æŸ“æ˜¾ç¤ºèœï¼‰

---

### ç±»æ¯”2ï¼šæˆ¿é—´ç¯çš„å¼€å…³

```typescript
function Room() {
  useEffect(() => {
    // è¿›å…¥æˆ¿é—´ â†’ å¼€ç¯
    turnOnLight()
    
    // ç¦»å¼€æˆ¿é—´ â†’ å…³ç¯ï¼ˆæ¸…ç†ï¼‰
    return () => {
      turnOffLight()
    }
  }, [])
}
```

**æµç¨‹**ï¼š
- è¿›å…¥ç»„ä»¶ = è¿›å…¥æˆ¿é—´ â†’ å¼€ç¯
- ç¦»å¼€ç»„ä»¶ = ç¦»å¼€æˆ¿é—´ â†’ å…³ç¯

---

## ğŸ” åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­çš„å…·ä½“åº”ç”¨

### åœºæ™¯1ï¼šé¦–æ¬¡åŠ è½½åº”ç”¨

```typescript
ç”¨æˆ·æ‰“å¼€ç½‘ç«™
  â†“
React æ¸²æŸ“ <UserProvider>
  â†“ (æ­¤æ—¶ user=null, loading=true)
æ˜¾ç¤º loading ç•Œé¢ â³
  â†“
useEffect è¿è¡Œ
  â†“
è°ƒç”¨ supabase.auth.getUser() (ç½‘ç»œè¯·æ±‚ 200ms)
  â†“
setUser(userData) â†’ è§¦å‘é‡æ–°æ¸²æŸ“
  â†“
è°ƒç”¨ supabase.from('profiles').select() (ç½‘ç»œè¯·æ±‚ 150ms)
  â†“
setProfile(profileData) â†’ è§¦å‘é‡æ–°æ¸²æŸ“
  â†“
setLoading(false) â†’ æœ€åä¸€æ¬¡æ¸²æŸ“
  â†“
æ˜¾ç¤ºçœŸå®å†…å®¹ âœ…
```

**æ€»è€—æ—¶**ï¼š~350msï¼ˆä½†ä¸é˜»å¡æ¸²æŸ“ï¼Œç”¨æˆ·èƒ½ç«‹å³çœ‹åˆ° loadingï¼‰

---

### åœºæ™¯2ï¼šç”¨æˆ·ç™»å½•

```typescript
ç”¨æˆ·ç‚¹å‡»"ç™»å½•"æŒ‰é’®
  â†“
è°ƒç”¨ supabase.auth.signInWithPassword()
  â†“
ç™»å½•æˆåŠŸ
  â†“
Supabase è§¦å‘ 'SIGNED_IN' äº‹ä»¶
  â†“
useEffect ä¸­çš„ onAuthStateChange ç›‘å¬å™¨æ”¶åˆ°é€šçŸ¥
  â†“
æ‰§è¡Œï¼š
  setUser(session.user)
  è·å– profile
  setProfile(profileData)
  â†“
ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œæ˜¾ç¤ºç™»å½•åçš„ç•Œé¢ âœ…
```

**å…³é”®**ï¼šä¸éœ€è¦æ‰‹åŠ¨åˆ·æ–°ï¼Œäº‹ä»¶ç›‘å¬å™¨è‡ªåŠ¨æ›´æ–°ï¼

---

### åœºæ™¯3ï¼šç”¨æˆ·ç™»å‡º

```typescript
ç”¨æˆ·ç‚¹å‡»"ç™»å‡º"æŒ‰é’®
  â†“
è°ƒç”¨ signOut() å‡½æ•°
  â†“
supabase.auth.signOut()
  â†“
Supabase è§¦å‘ 'SIGNED_OUT' äº‹ä»¶
  â†“
useEffect ä¸­çš„ç›‘å¬å™¨æ”¶åˆ°é€šçŸ¥
  â†“
æ‰§è¡Œï¼š
  setUser(null)
  setProfile(null)
  â†“
ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œæ˜¾ç¤ºæœªç™»å½•ç•Œé¢ âœ…
  â†“
Dashboard æ£€æµ‹åˆ° user=nullï¼Œé‡å®šå‘åˆ° /auth
```

---

## ğŸ’¡ æ€»ç»“

### useEffect è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ

| é—®é¢˜ | å¦‚æœæ²¡æœ‰ useEffect | ä½¿ç”¨ useEffect |
|------|-------------------|---------------|
| å¼‚æ­¥æ“ä½œ | âŒ ä¸èƒ½ç›´æ¥ await | âœ… å¯ä»¥åœ¨ effect ä¸­ await |
| ä½•æ—¶æ‰§è¡Œ | âŒ æ¸²æŸ“æ—¶æ‰§è¡Œï¼Œå¯èƒ½é˜»å¡ | âœ… æ¸²æŸ“åæ‰§è¡Œï¼Œä¸é˜»å¡ |
| æ— é™å¾ªç¯ | âŒ å®¹æ˜“é™·å…¥æ­»å¾ªç¯ | âœ… ä¾èµ–æ•°ç»„æ§åˆ¶ |
| èµ„æºæ¸…ç† | âŒ å®¹æ˜“å†…å­˜æ³„æ¼ | âœ… è¿”å›æ¸…ç†å‡½æ•° |

### æˆ‘ä»¬çš„ä»£ç ç”¨ useEffect åšäº†ä»€ä¹ˆï¼Ÿ

```typescript
useEffect(() => {
  // 1. â¬ ä¸‹è½½ï¼šè·å–ç”¨æˆ·å’Œprofileæ•°æ®
  loadUser()
  
  // 2. ğŸ‘‚ ç›‘å¬ï¼šç›‘å¬ç™»å½•/ç™»å‡ºäº‹ä»¶
  const sub = supabase.auth.onAuthStateChange(...)
  
  // 3. ğŸ§¹ æ¸…ç†ï¼šç»„ä»¶å¸è½½æ—¶å–æ¶ˆç›‘å¬
  return () => sub.unsubscribe()
}, [supabase])  // 4. ğŸ¯ æ§åˆ¶ï¼šåªåœ¨ supabase æ”¹å˜æ—¶é‡æ–°è¿è¡Œï¼ˆå®é™…ä¸Šæ°¸è¿œä¸ä¼šï¼‰
```

### ä¸€å¥è¯æ€»ç»“

**useEffect = åœ¨ç»„ä»¶æ˜¾ç¤ºååšä¸€äº›"å‰¯ä½œç”¨"æ“ä½œï¼ˆè·å–æ•°æ®ã€ç›‘å¬äº‹ä»¶ç­‰ï¼‰ï¼Œå¹¶åœ¨ç»„ä»¶æ¶ˆå¤±å‰æ¸…ç†ã€‚**

å°±è¿™ä¹ˆç®€å•ï¼ğŸ‰


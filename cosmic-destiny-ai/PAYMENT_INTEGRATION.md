# 支付集成指南

## 概述

当前系统已经实现了免费预览和付费解锁的报告功能。用户可以：
1. 免费生成预览报告（500-800字）
2. 付费后解锁完整报告（3000+字）

## 当前实现

### 技术流程

1. **生成预览报告**
   - 用户填写出生信息
   - 系统调用 `/api/reports/generate` 生成预览报告
   - 报告存储在数据库的 `preview_report` 字段

2. **升级到完整报告**
   - 用户点击"解锁完整报告"按钮
   - 系统调用 `/api/reports/[id]/upgrade` 生成完整报告
   - 报告存储在数据库的 `full_report` 字段
   - `is_paid` 标记更新为 true

### 测试模式

当前为了测试，升级功能是免费的。点击"立即解锁完整报告"会直接生成完整报告。

## 支付集成建议

### 推荐支付服务商

1. **Stripe**（国际用户）
   - 支持多种支付方式
   - 集成简单，文档完善
   - 支持订阅和一次性付款

2. **支付宝/微信支付**（中国用户）
   - 覆盖中国主流支付方式
   - 需要企业资质

### 集成步骤

1. **选择支付服务商**
2. **注册并获取 API 密钥**
3. **安装相应的 SDK**
   ```bash
   npm install stripe  # 如果使用 Stripe
   ```

4. **修改升级流程**
   ```typescript
   // 在 handleUpgrade 函数中添加支付流程
   const handleUpgrade = async () => {
     // 1. 创建支付会话
     const payment = await createPaymentSession(reportId, amount)
     
     // 2. 重定向到支付页面
     await redirectToPayment(payment.url)
     
     // 3. 支付成功后的回调会触发报告升级
   }
   ```

5. **添加支付回调处理**
   - 创建 `/api/payments/webhook` 端点
   - 验证支付成功后调用升级 API

## 价格建议

- **预览报告**：免费
- **完整报告**：$9.99 / ¥68（一次性付费，永久查看）
- **批量优惠**：购买3份85折，5份8折

## 安全注意事项

1. **验证支付状态**：在升级报告前必须验证支付确实成功
2. **防止重复支付**：检查报告是否已经是付费状态
3. **保护 API 密钥**：所有支付相关密钥存储在环境变量中
4. **使用 HTTPS**：确保所有支付相关通信都通过 HTTPS

## 用户体验优化

1. **支付前预览**：清楚展示用户将获得什么
2. **支付进度提示**：显示支付处理中的状态
3. **支付失败处理**：友好的错误提示和重试选项
4. **发票/收据**：支付成功后提供电子收据

import { NextRequest, NextResponse } from 'next/server'
import { ZhipuService } from '@/services/zhipuService'
import { BaziService } from '@/services/baziService'

export const dynamic = 'force-dynamic'

// Extract preview report from full report (first 1500-2000 characters)
function extractPreviewFromFullReport(fullReport: string): string {
  // Find a good breaking point around 1500-2000 characters
  const targetLength = 1800
  let preview = fullReport.substring(0, targetLength)
  
  // Try to break at a sentence or paragraph boundary
  const lastSentenceEnd = Math.max(
    preview.lastIndexOf('ã€‚'),
    preview.lastIndexOf('ï¼'),
    preview.lastIndexOf('ï¼Ÿ'),
    preview.lastIndexOf('\n\n')
  )
  
  if (lastSentenceEnd > targetLength * 0.7) {
    preview = preview.substring(0, lastSentenceEnd + 1)
  }
  
  // Add preview ending
  preview += `

---

**æƒ³è¦äº†è§£æ›´å¤šè¯¦ç»†å†…å®¹å—ï¼Ÿ**

å®Œæ•´æŠ¥å‘ŠåŒ…å«ï¼š
- æ·±åº¦äººæ ¼åˆ†æå’Œæˆé•¿å»ºè®®
- è¯¦ç»†èŒä¸šè§„åˆ’å’Œè´¢å¯Œç­–ç•¥  
- å…¨é¢æ„Ÿæƒ…åˆ†æå’Œæœ€ä½³é…å¯¹
- äººç”Ÿä½¿å‘½å’Œå…³é”®è½¬æŠ˜ç‚¹
- ä¸ªæ€§åŒ–å¥åº·å…»ç”Ÿæ–¹æ¡ˆ
- å¤§è¿æµå¹´è¯¦ç»†åˆ†æ
- æœ‰åˆ©ä¸åˆ©å› ç´ æ·±åº¦è§£è¯»
- ä»¥åŠæ›´å¤šä¸“å±äºæ‚¨çš„å‘½ç†æŒ‡å¯¼...

ç«‹å³è§£é”å®Œæ•´æŠ¥å‘Šï¼Œå¼€å¯æ‚¨çš„å‘½è¿æ¢ç´¢ä¹‹æ—…ï¼`
  
  return preview
}

// ç”Ÿæˆæ¨¡æ‹Ÿé¢„è§ˆæŠ¥å‘Šï¼ˆæµ‹è¯•ç”¨ï¼Œ500-800å­—ï¼‰
function generateMockPreviewReport(birthData: any, baziData: any): string {
  return `# æ‚¨çš„å‘½ç†æ¦‚è§ˆ

## å‡ºç”Ÿä¿¡æ¯
- å‡ºç”Ÿæ—¥æœŸï¼š${birthData.birthDate}
- å‡ºç”Ÿæ—¶é—´ï¼š${birthData.birthTime || '12:00'}${birthData.isTimeKnownInput ? ' (ç”¨æˆ·æä¾›)' : ' (ç³»ç»Ÿé»˜è®¤)'}
- æ€§åˆ«ï¼š${birthData.gender === 'male' ? 'ç”·' : 'å¥³'}

## æ ¸å¿ƒæ€§æ ¼ç‰¹å¾
åŸºäºæ‚¨çš„å…«å­—åˆ†æï¼Œæ‚¨çš„æ—¥ä¸»ä¸º${baziData.dayMaster}ï¼Œè¿™èµ‹äºˆäº†æ‚¨ç‹¬ç‰¹çš„ä¸ªæ€§é­…åŠ›ã€‚æ‚¨æ˜¯ä¸€ä¸ªå……æ»¡æ™ºæ…§å’Œåˆ›é€ åŠ›çš„äººï¼Œå–„äºè§‚å¯Ÿå’Œæ€è€ƒï¼Œæ€»èƒ½åœ¨ç»†èŠ‚ä¸­å‘ç°åˆ«äººå¿½è§†çš„ä»·å€¼ã€‚æ‚¨çš„å†…å¿ƒæ·±å¤„æœ‰ç€å¯¹å®Œç¾çš„è¿½æ±‚ï¼Œè¿™ä½¿æ‚¨åœ¨åšäº‹æ—¶æ ¼å¤–è®¤çœŸç»†è‡´ã€‚åŒæ—¶ï¼Œæ‚¨å…·æœ‰å¾ˆå¼ºçš„ç›´è§‰åŠ›å’ŒåŒç†å¿ƒï¼Œèƒ½å¤Ÿæ•é”åœ°æ„ŸçŸ¥ä»–äººçš„æƒ…ç»ªå˜åŒ–ã€‚

## å¤©èµ‹æ½œèƒ½
æ‚¨æœ€çªå‡ºçš„å¤©èµ‹åœ¨äºåˆ›æ–°æ€ç»´å’Œæ²Ÿé€šèƒ½åŠ›ã€‚æ‚¨å¤©ç”Ÿå…·æœ‰å°†å¤æ‚æ¦‚å¿µç®€å•åŒ–çš„èƒ½åŠ›ï¼Œå–„äºç”¨ç‹¬ç‰¹çš„è§†è§’è§£å†³é—®é¢˜ã€‚åœ¨è‰ºæœ¯åˆ›ä½œã€ç­–ç•¥è§„åˆ’æˆ–äººé™…äº¤å¾€æ–¹é¢ï¼Œæ‚¨éƒ½å±•ç°å‡ºè¶…ä¹å¸¸äººçš„å¤©èµ‹ã€‚ç‰¹åˆ«æ˜¯åœ¨éœ€è¦åˆ›æ„å’Œçµæ„Ÿçš„é¢†åŸŸï¼Œæ‚¨æ€»èƒ½è¿¸å‘å‡ºä»¤äººæƒŠå–œçš„æƒ³æ³•ã€‚

## äº‹ä¸šæ–¹å‘
æ ¹æ®æ‚¨çš„äº”è¡Œé…ç½®ï¼Œæœ€é€‚åˆæ‚¨çš„èŒä¸šæ–¹å‘æ˜¯åˆ›æ„äº§ä¸šå’ŒçŸ¥è¯†æœåŠ¡ä¸šã€‚è®¾è®¡ã€åª’ä½“ã€æ•™è‚²ã€å’¨è¯¢ç­‰éœ€è¦åˆ›é€ åŠ›å’Œæ²Ÿé€šèƒ½åŠ›çš„è¡Œä¸šéƒ½å¾ˆé€‚åˆæ‚¨ã€‚æ‚¨ä¹Ÿé€‚åˆæ‹…ä»»å›¢é˜Ÿçš„æ™ºå›Šè§’è‰²ï¼Œä¸ºç»„ç»‡æä¾›æˆ˜ç•¥æ€§å»ºè®®ã€‚åˆ›ä¸šä¹Ÿæ˜¯ä¸é”™çš„é€‰æ‹©ï¼Œç‰¹åˆ«æ˜¯åœ¨æ–‡åŒ–åˆ›æ„æˆ–ç§‘æŠ€åˆ›æ–°é¢†åŸŸã€‚

## æ„Ÿæƒ…è¿åŠ¿
åœ¨æ„Ÿæƒ…æ–¹é¢ï¼Œæ‚¨è¿½æ±‚å¿ƒçµå±‚é¢çš„å…±é¸£ã€‚æ‚¨éœ€è¦ä¸€ä¸ªèƒ½å¤Ÿç†è§£æ‚¨å†…å¿ƒä¸–ç•Œã€ä¸æ‚¨è¿›è¡Œæ·±åº¦äº¤æµçš„ä¼´ä¾£ã€‚æ‚¨çš„æ„Ÿæƒ…è¡¨è¾¾æ–¹å¼å«è“„è€Œæ·±æƒ…ï¼Œæ›´å–œæ¬¢ç”¨è¡ŒåŠ¨è€Œéè¨€è¯­æ¥è¡¨è¾¾çˆ±æ„ã€‚å»ºè®®æ‚¨åœ¨é€‰æ‹©ä¼´ä¾£æ—¶ï¼Œé‡è§†ç²¾ç¥å¥‘åˆåº¦ï¼Œå¯»æ‰¾èƒ½å¤Ÿå…±åŒæˆé•¿çš„äººç”Ÿä¼´ä¾£ã€‚

---

**æƒ³è¦äº†è§£æ›´å¤šè¯¦ç»†å†…å®¹å—ï¼Ÿ**

å®Œæ•´æŠ¥å‘ŠåŒ…å«ï¼š
- æ·±åº¦äººæ ¼åˆ†æå’Œæˆé•¿å»ºè®®
- è¯¦ç»†èŒä¸šè§„åˆ’å’Œè´¢å¯Œç­–ç•¥  
- å…¨é¢æ„Ÿæƒ…åˆ†æå’Œæœ€ä½³é…å¯¹
- äººç”Ÿä½¿å‘½å’Œå…³é”®è½¬æŠ˜ç‚¹
- ä¸ªæ€§åŒ–å¥åº·å…»ç”Ÿæ–¹æ¡ˆ
- ä»¥åŠæ›´å¤šä¸“å±äºæ‚¨çš„å‘½ç†æŒ‡å¯¼...

ç«‹å³è§£é”å®Œæ•´æŠ¥å‘Šï¼Œå¼€å¯æ‚¨çš„å‘½è¿æ¢ç´¢ä¹‹æ—…ï¼`;
}

// æ¨¡æ‹ŸæŠ¥å‘Šç”Ÿæˆå‡½æ•°ï¼ˆæµ‹è¯•ç”¨ï¼‰
function generateMockReport(birthData: any, baziData: any): string {
  return `# å®‡å®™å‘½ç†åˆ†ææŠ¥å‘Š

## å‡ºç”Ÿä¿¡æ¯
- å‡ºç”Ÿæ—¥æœŸï¼š${birthData.birthDate}
- å‡ºç”Ÿæ—¶é—´ï¼š${birthData.birthTime || '12:00'}${birthData.isTimeKnownInput ? ' (ç”¨æˆ·æä¾›)' : ' (ç³»ç»Ÿé»˜è®¤)'}
- æ€§åˆ«ï¼š${birthData.gender === 'male' ? 'ç”·' : 'å¥³'}
- æ—¶åŒºï¼š${birthData.timeZone}

## å…«å­—ä¿¡æ¯
- å¤©å¹²ï¼š${baziData.heavenlyStems.join('ã€')}
- åœ°æ”¯ï¼š${baziData.earthlyBranches.join('ã€')}
- æ—¥ä¸»ï¼š${baziData.dayMaster}
- äº”è¡Œåˆ†å¸ƒï¼šæœ¨${baziData.elements.wood}ã€ç«${baziData.elements.fire}ã€åœŸ${baziData.elements.earth}ã€é‡‘${baziData.elements.metal}ã€æ°´${baziData.elements.water}

---

# ä¸€ã€äººæ ¼ç‰¹è´¨åˆ†æ

## æ ¸å¿ƒæ€§æ ¼ç‰¹å¾
åŸºäºæ‚¨çš„å…«å­—åˆ†æï¼Œæ‚¨çš„æ—¥ä¸»ä¸º${baziData.dayMaster}ï¼Œè¿™èµ‹äºˆäº†æ‚¨ç‹¬ç‰¹çš„æ€§æ ¼ç‰¹è´¨ã€‚${baziData.dayMaster}æ—¥ä¸»çš„äººé€šå¸¸å…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š

æ‚¨æ˜¯ä¸€ä¸ªå……æ»¡æ™ºæ…§å’Œåˆ›é€ åŠ›çš„äººï¼Œå–„äºæ€è€ƒå’Œåˆ†æé—®é¢˜ã€‚æ‚¨çš„æ€§æ ¼ä¸­è•´å«ç€æ·±é‚ƒçš„æ´å¯ŸåŠ›ï¼Œèƒ½å¤Ÿçœ‹é€äº‹ç‰©çš„æœ¬è´¨ã€‚åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­ï¼Œæ‚¨è¡¨ç°å‡ºç¨³é‡è€Œä¸å¤±çµæ´»çš„ç‰¹è´¨ï¼Œæ—¢èƒ½å¤Ÿåšå®ˆåŸåˆ™ï¼Œåˆèƒ½å¤Ÿé€‚åº”å˜åŒ–ã€‚

æ‚¨çš„æ€ç»´æ–¹å¼ç‹¬ç‰¹è€Œæ•é”ï¼Œå¸¸å¸¸èƒ½å¤Ÿæå‡ºæ–°é¢–çš„è§è§£å’Œåˆ›æ„ã€‚è¿™ç§å¤©èµ‹ä½¿æ‚¨åœ¨è§£å†³é—®é¢˜æ—¶æ€»èƒ½æ‰¾åˆ°åˆ«äººå¿½è§†çš„è§’åº¦ã€‚åŒæ—¶ï¼Œæ‚¨ä¹Ÿå…·æœ‰å¾ˆå¼ºçš„ç›´è§‰åŠ›ï¼Œèƒ½å¤Ÿæ„ŸçŸ¥åˆ°ä»–äººçš„æƒ…ç»ªå’Œéœ€æ±‚ã€‚

## å¤©èµ‹ä¸ä¼˜åŠ¿
1. **åˆ›æ–°æ€ç»´**ï¼šæ‚¨å¤©ç”Ÿå…·æœ‰åˆ›æ–°ç²¾ç¥ï¼Œå–„äºæ‰“ç ´å¸¸è§„ï¼Œå¯»æ‰¾æ–°çš„è§£å†³æ–¹æ¡ˆã€‚
2. **æ²Ÿé€šèƒ½åŠ›**ï¼šæ‚¨çš„è¡¨è¾¾èƒ½åŠ›å‡ºè‰²ï¼Œèƒ½å¤Ÿæ¸…æ™°åœ°ä¼ è¾¾è‡ªå·±çš„æƒ³æ³•å’Œæ„Ÿå—ã€‚
3. **å­¦ä¹ èƒ½åŠ›**ï¼šæ‚¨å¯¹çŸ¥è¯†æœ‰ç€å¼ºçƒˆçš„æ¸´æœ›ï¼Œå­¦ä¹ æ–°äº‹ç‰©çš„é€Ÿåº¦å¿«ä¸”æ‰å®ã€‚
4. **é€‚åº”èƒ½åŠ›**ï¼šé¢å¯¹å˜åŒ–ï¼Œæ‚¨èƒ½å¤Ÿå¿«é€Ÿè°ƒæ•´ç­–ç•¥ï¼Œå±•ç°å‡ºè‰¯å¥½çš„çµæ´»æ€§ã€‚
5. **é¢†å¯¼æ½œè´¨**ï¼šæ‚¨å…·æœ‰å¤©ç”Ÿçš„é¢†å¯¼æ‰èƒ½ï¼Œèƒ½å¤Ÿæ¿€åŠ±å’Œå¸¦é¢†ä»–äººå‰è¿›ã€‚

## éœ€è¦æ”¹è¿›çš„æ–¹é¢
è™½ç„¶æ‚¨æ‹¥æœ‰è¯¸å¤šä¼˜ç‚¹ï¼Œä½†ä»æœ‰ä¸€äº›éœ€è¦æ³¨æ„å’Œæ”¹è¿›çš„åœ°æ–¹ï¼š

1. **è¿‡åº¦æ€è™‘**ï¼šæœ‰æ—¶æ‚¨å¯èƒ½ä¼šæƒ³å¾—å¤ªå¤šï¼Œå¯¼è‡´å†³ç­–å»¶è¿Ÿæˆ–é”™å¤±è‰¯æœºã€‚
2. **æƒ…ç»ªç®¡ç†**ï¼šåœ¨å‹åŠ›ä¸‹ï¼Œæ‚¨å¯èƒ½ä¼šè¡¨ç°å‡ºæƒ…ç»ªæ³¢åŠ¨ï¼Œéœ€è¦å­¦ä¹ æ›´å¥½çš„æƒ…ç»ªè°ƒèŠ‚æŠ€å·§ã€‚
3. **å®Œç¾ä¸»ä¹‰**ï¼šå¯¹è‡ªå·±å’Œä»–äººè¦æ±‚è¿‡é«˜ï¼Œå¯èƒ½ä¼šå¸¦æ¥ä¸å¿…è¦çš„å‹åŠ›ã€‚
4. **æ—¶é—´ç®¡ç†**ï¼šæ‚¨å¯èƒ½ä¼šåŒæ—¶å…³æ³¨å¤ªå¤šäº‹æƒ…ï¼Œéœ€è¦å­¦ä¹ ä¼˜å…ˆçº§æ’åºã€‚

## ç¤¾äº¤é£æ ¼
åœ¨ç¤¾äº¤åœºåˆä¸­ï¼Œæ‚¨å±•ç°å‡ºç‹¬ç‰¹çš„é­…åŠ›ã€‚æ‚¨å–„äºå€¾å¬ï¼Œèƒ½å¤ŸçœŸè¯šåœ°ç†è§£ä»–äººçš„æƒ³æ³•å’Œæ„Ÿå—ã€‚è¿™ä½¿æ‚¨æˆä¸ºæœ‹å‹åœˆä¸­å—æ¬¢è¿çš„äººç‰©ã€‚æ‚¨çš„ç¤¾äº¤é£æ ¼æ—¢ä¸è¿‡äºçƒ­æƒ…ï¼Œä¹Ÿä¸è¿‡äºå†·æ·¡ï¼Œæ°åˆ°å¥½å¤„åœ°ä¿æŒç€èˆ’é€‚çš„äººé™…è·ç¦»ã€‚

---

# äºŒã€èŒä¸šå‘å±•æŒ‡å¯¼

## æœ€é€‚åˆçš„èŒä¸šé¢†åŸŸ
æ ¹æ®æ‚¨çš„äº”è¡Œé…ç½®å’Œæ€§æ ¼ç‰¹è´¨ï¼Œä»¥ä¸‹èŒä¸šé¢†åŸŸç‰¹åˆ«é€‚åˆæ‚¨ï¼š

1. **åˆ›æ„äº§ä¸š**ï¼šè®¾è®¡ã€è‰ºæœ¯ã€å¹¿å‘Šã€åª’ä½“ç­‰éœ€è¦åˆ›é€ åŠ›çš„è¡Œä¸š
2. **ç§‘æŠ€é¢†åŸŸ**ï¼šè½¯ä»¶å¼€å‘ã€æ•°æ®åˆ†æã€äººå·¥æ™ºèƒ½ã€åˆ›æ–°ç§‘æŠ€
3. **æ•™è‚²åŸ¹è®­**ï¼šæ•™å¸ˆã€åŸ¹è®­å¸ˆã€æ•™è‚²é¡¾é—®ã€çŸ¥è¯†ä¼ æ’­è€…
4. **å’¨è¯¢æœåŠ¡**ï¼šç®¡ç†å’¨è¯¢ã€å¿ƒç†å’¨è¯¢ã€èŒä¸šè§„åˆ’å¸ˆ
5. **é‡‘èæŠ•èµ„**ï¼šæŠ•èµ„åˆ†æã€é‡‘èè§„åˆ’ã€é£é™©ç®¡ç†

## åˆ›ä¸šæ½œè´¨è¯„ä¼°
æ‚¨å…·æœ‰è¾ƒå¼ºçš„åˆ›ä¸šæ½œè´¨ã€‚æ‚¨çš„åˆ›æ–°æ€ç»´å’Œé¢†å¯¼èƒ½åŠ›ä¸ºåˆ›ä¸šæä¾›äº†è‰¯å¥½çš„åŸºç¡€ã€‚ç‰¹åˆ«æ˜¯åœ¨ä»¥ä¸‹ç±»å‹çš„åˆ›ä¸šé¡¹ç›®ä¸­ï¼Œæ‚¨æ›´å®¹æ˜“è·å¾—æˆåŠŸï¼š

- **çŸ¥è¯†å‹åˆ›ä¸š**ï¼šåœ¨çº¿æ•™è‚²ã€å†…å®¹åˆ›ä½œã€çŸ¥è¯†ä»˜è´¹å¹³å°
- **æŠ€æœ¯å‹åˆ›ä¸š**ï¼šç§‘æŠ€äº§å“å¼€å‘ã€è½¯ä»¶æœåŠ¡ã€åˆ›æ–°è§£å†³æ–¹æ¡ˆ
- **æœåŠ¡å‹åˆ›ä¸š**ï¼šå’¨è¯¢æœåŠ¡ã€ä¸ªäººå“ç‰Œã€ä¸“ä¸šæœåŠ¡

å»ºè®®æ‚¨åœ¨åˆ›ä¸šåˆæœŸæ‰¾åˆ°äº’è¡¥çš„åˆä½œä¼™ä¼´ï¼Œç‰¹åˆ«æ˜¯åœ¨æ‰§è¡ŒåŠ›å’Œç»†èŠ‚ç®¡ç†æ–¹é¢èƒ½å¤Ÿå¼¥è¡¥æ‚¨çš„ä¸è¶³çš„äººã€‚

## è´¢å¯Œç´¯ç§¯ç­–ç•¥
1. **å¤šå…ƒåŒ–æ”¶å…¥**ï¼šå»ºç«‹å¤šä¸ªæ”¶å…¥æ¥æºï¼Œä¸è¦ä¾èµ–å•ä¸€æ”¶å…¥
2. **é•¿æœŸæŠ•èµ„**ï¼šæ³¨é‡é•¿æœŸä»·å€¼æŠ•èµ„ï¼Œé¿å…çŸ­æœŸæŠ•æœº
3. **çŸ¥è¯†å˜ç°**ï¼šå°†æ‚¨çš„ä¸“ä¸šçŸ¥è¯†å’ŒæŠ€èƒ½è½¬åŒ–ä¸ºæ”¶å…¥
4. **ç†æ€§æ¶ˆè´¹**ï¼šåˆ¶å®šé¢„ç®—è®¡åˆ’ï¼Œé¿å…å†²åŠ¨æ¶ˆè´¹
5. **æŒç»­å­¦ä¹ **ï¼šæŠ•èµ„è‡ªå·±çš„æˆé•¿ï¼Œæå‡ä¸“ä¸šæŠ€èƒ½å’Œè®¤çŸ¥æ°´å¹³

## èŒåœºå‘å±•å»ºè®®
- **çŸ­æœŸç›®æ ‡ï¼ˆ1-2å¹´ï¼‰**ï¼šä¸“æ³¨äºæŠ€èƒ½æå‡å’Œäººè„‰ç§¯ç´¯
- **ä¸­æœŸç›®æ ‡ï¼ˆ3-5å¹´ï¼‰**ï¼šå¯»æ±‚æ›´é«˜çš„èŒä½æˆ–åˆ›ä¸šæœºä¼š
- **é•¿æœŸç›®æ ‡ï¼ˆ5å¹´ä»¥ä¸Šï¼‰**ï¼šå»ºç«‹ä¸ªäººå“ç‰Œå’Œå½±å“åŠ›

---

# ä¸‰ã€æƒ…æ„Ÿå…³ç³»åˆ†æ

## çˆ±æƒ…æ¨¡å¼
æ‚¨åœ¨çˆ±æƒ…ä¸­è¿½æ±‚ç²¾ç¥å±‚é¢çš„å…±é¸£ã€‚å¯¹æ‚¨æ¥è¯´ï¼Œä¼´ä¾£ä¸ä»…æ˜¯ç”Ÿæ´»çš„ä¼´ä¾£ï¼Œæ›´æ˜¯çµé­‚çš„çŸ¥å·±ã€‚æ‚¨é‡è§†æ·±åº¦çš„æƒ…æ„Ÿäº¤æµï¼Œå¸Œæœ›ä¸ä¼´ä¾£åˆ†äº«æ€æƒ³ã€æ¢¦æƒ³å’Œäººç”Ÿæ„Ÿæ‚Ÿã€‚

æ‚¨çš„çˆ±æƒ…è¡¨è¾¾æ–¹å¼å«è“„è€Œæ·±æƒ…ã€‚æ‚¨ä¸å¤ªæ“…é•¿ç”œè¨€èœœè¯­ï¼Œä½†ä¼šé€šè¿‡å®é™…è¡ŒåŠ¨æ¥è¡¨è¾¾çˆ±æ„ã€‚æ‚¨éœ€è¦ä¸€ä¸ªèƒ½å¤Ÿç†è§£æ‚¨å†…å¿ƒä¸–ç•Œçš„ä¼´ä¾£ï¼Œä¸€ä¸ªèƒ½å¤Ÿä¸æ‚¨è¿›è¡Œæ·±åº¦å¯¹è¯çš„äººã€‚

## æœ€ä½³é…å¯¹ç±»å‹
æ ¹æ®äº”è¡Œç›¸ç”Ÿç›¸å…‹çš„åŸç†ï¼Œæœ€é€‚åˆæ‚¨çš„ä¼´ä¾£ç±»å‹æ˜¯ï¼š

1. **äº’è¡¥å‹**ï¼šäº”è¡Œä¸­æ‚¨æ‰€ç¼ºå°‘çš„å…ƒç´ ï¼Œå¯¹æ–¹èƒ½å¤Ÿè¡¥å……
2. **æ”¯æŒå‹**ï¼šèƒ½å¤Ÿç†è§£å’Œæ”¯æŒæ‚¨çš„ç†æƒ³å’Œè¿½æ±‚çš„äºº
3. **æˆé•¿å‹**ï¼šæ„¿æ„ä¸æ‚¨å…±åŒæˆé•¿ï¼Œå…±åŒè¿›æ­¥çš„ä¼´ä¾£

å…·ä½“æ¥è¯´ï¼Œæ€§æ ¼æ¸©å’Œã€æƒ…ç»ªç¨³å®šã€æœ‰è€å¿ƒä¸”å–„è§£äººæ„çš„äººæœ€é€‚åˆæ‚¨ã€‚

## å©šå§»è¿åŠ¿
æ‚¨çš„å©šå§»è¿åŠ¿æ•´ä½“è‰¯å¥½ã€‚æ‚¨é‡è§†å®¶åº­å’Œè°ï¼Œæ„¿æ„ä¸ºå®¶åº­ä»˜å‡ºåŠªåŠ›ã€‚åœ¨å©šå§»ä¸­ï¼Œæ‚¨éœ€è¦æ³¨æ„ï¼š

1. **æ²Ÿé€šæ–¹å¼**ï¼šå­¦ä¼šæ›´ç›´æ¥åœ°è¡¨è¾¾æƒ…æ„Ÿéœ€æ±‚
2. **æ—¶é—´åˆ†é…**ï¼šå¹³è¡¡å·¥ä½œä¸å®¶åº­çš„æ—¶é—´
3. **å…±åŒæˆé•¿**ï¼šä¸ä¼´ä¾£ä¿æŒåŒæ­¥æˆé•¿çš„èŠ‚å¥
4. **æµªæ¼«ç»´æŒ**ï¼šä¸è¦å› ä¸ºå¿™ç¢Œè€Œå¿½è§†æµªæ¼«çš„é‡è¦æ€§

## å®¶åº­å…³ç³»
æ‚¨åœ¨å®¶åº­ä¸­æ‰®æ¼”ç€é‡è¦çš„è§’è‰²ã€‚æ‚¨æ—¢èƒ½å¤Ÿæ‰¿æ‹…è´£ä»»ï¼Œåˆèƒ½å¤Ÿç»™äºˆå®¶äººæƒ…æ„Ÿæ”¯æŒã€‚å»ºè®®ï¼š

- å¤šèŠ±æ—¶é—´é™ªä¼´å®¶äººï¼Œç‰¹åˆ«æ˜¯çˆ¶æ¯å’Œå­©å­
- å­¦ä¼šè¡¨è¾¾å¯¹å®¶äººçš„å…³çˆ±å’Œæ„Ÿæ¿€
- åœ¨å®¶åº­å†³ç­–ä¸­ä¿æŒæ°‘ä¸»å’Œå¼€æ”¾çš„æ€åº¦
- åˆ›é€ æ¸©é¦¨çš„å®¶åº­æ°›å›´å’Œä¼ ç»Ÿ

---

# å››ã€äººç”Ÿä½¿å‘½ä¸æˆé•¿

## ç”Ÿå‘½æ ¸å¿ƒä½¿å‘½
æ‚¨çš„ç”Ÿå‘½ä½¿å‘½æ˜¯æˆä¸ºä¸€ä¸ªå¯å‘è€…å’Œå¼•å¯¼è€…ã€‚æ‚¨è¢«èµ‹äºˆäº†ç‹¬ç‰¹çš„æ´å¯ŸåŠ›å’Œæ™ºæ…§ï¼Œè¿™ä½¿æ‚¨èƒ½å¤Ÿå¸®åŠ©ä»–äººçœ‹æ¸…æ–¹å‘ï¼Œæ‰¾åˆ°äººç”Ÿçš„æ„ä¹‰ã€‚æ— è®ºåœ¨ä»€ä¹ˆé¢†åŸŸï¼Œæ‚¨éƒ½æœ‰æ½œåŠ›æˆä¸ºæ€æƒ³çš„å¼•é¢†è€…å’Œåˆ›æ–°çš„æ¨åŠ¨è€…ã€‚

æ‚¨çš„å­˜åœ¨æœ¬èº«å°±æ˜¯ä¸€ç§å¯å‘ã€‚é€šè¿‡æ‚¨çš„è¨€è¡Œã€ä½œå“æˆ–æˆå°±ï¼Œæ‚¨èƒ½å¤Ÿæ¿€åŠ±ä»–äººè¿½æ±‚æ›´é«˜çš„ç›®æ ‡ï¼Œå®ç°æ›´å¤§çš„æ¢¦æƒ³ã€‚

## äººç”Ÿå‘å±•é˜¶æ®µ
**é’å¹´æœŸï¼ˆ20-35å²ï¼‰**ï¼šæ¢ç´¢å’Œç§¯ç´¯é˜¶æ®µ
- é‡ç‚¹ï¼šå­¦ä¹ ã€ä½“éªŒã€å»ºç«‹åŸºç¡€
- å»ºè®®ï¼šå¹¿æ³›å°è¯•ï¼Œæ‰¾åˆ°çœŸæ­£çš„å…´è¶£å’Œå¤©èµ‹æ‰€åœ¨

**ä¸­å¹´æœŸï¼ˆ35-50å²ï¼‰**ï¼šå‘å±•å’Œæˆå°±é˜¶æ®µ
- é‡ç‚¹ï¼šäº‹ä¸šå‘å±•ã€å®¶åº­å»ºè®¾ã€ç¤¾ä¼šè´¡çŒ®
- å»ºè®®ï¼šä¸“æ³¨äºæ ¸å¿ƒé¢†åŸŸï¼Œå»ºç«‹ä¸“ä¸šå½±å“åŠ›

**æˆç†ŸæœŸï¼ˆ50-65å²ï¼‰**ï¼šä¼ æ‰¿å’Œå‡åé˜¶æ®µ
- é‡ç‚¹ï¼šç»éªŒä¼ æ‰¿ã€æ™ºæ…§åˆ†äº«ã€ç²¾ç¥è¿½æ±‚
- å»ºè®®ï¼šåŸ¹å…»åè¾ˆï¼Œå›é¦ˆç¤¾ä¼šï¼Œè¿½æ±‚å†…å¿ƒå¹³é™

**æ™šå¹´æœŸï¼ˆ65å²ä»¥åï¼‰**ï¼šåœ†æ»¡å’Œè¶…ç„¶é˜¶æ®µ
- é‡ç‚¹ï¼šç”Ÿå‘½å›é¡¾ã€ç²¾ç¥ä¿®å…»ã€å®‰äº«æ™šå¹´
- å»ºè®®ï¼šä¿æŒå­¦ä¹ çƒ­æƒ…ï¼Œäº«å—ç”Ÿæ´»çš„ç¾å¥½

## ç²¾ç¥æˆé•¿è·¯å¾„
1. **è‡ªæˆ‘è®¤çŸ¥**ï¼šæ·±å…¥äº†è§£è‡ªå·±çš„å†…å¿ƒä¸–ç•Œ
2. **æƒ…ç»ªæˆç†Ÿ**ï¼šå­¦ä¼šç®¡ç†å’Œè½¬åŒ–æƒ…ç»ªèƒ½é‡
3. **æ™ºæ…§æå‡**ï¼šé€šè¿‡å­¦ä¹ å’Œä½“éªŒå¢é•¿æ™ºæ…§
4. **å¿ƒçµè§‰é†’**ï¼šè¿½æ±‚æ›´é«˜å±‚æ¬¡çš„ç²¾ç¥å¢ƒç•Œ
5. **åˆ©ä»–å¥‰çŒ®**ï¼šç”¨è‡ªå·±çš„èƒ½åŠ›æœåŠ¡ä»–äººå’Œç¤¾ä¼š

## å…³é”®äººç”Ÿè½¬æŠ˜ç‚¹
- **28-30å²**ï¼šäº‹ä¸šæ–¹å‘çš„é‡è¦é€‰æ‹©æœŸ
- **35-37å²**ï¼šäººç”Ÿä»·å€¼è§‚çš„æ·±åŒ–æœŸ
- **42-45å²**ï¼šä¸­å¹´è½¬å‹çš„å…³é”®æœŸ
- **50-52å²**ï¼šäººç”Ÿæ™ºæ…§çš„æˆç†ŸæœŸ

---

# äº”ã€å¥åº·å…»ç”ŸæŒ‡å¯¼

## ä½“è´¨ç‰¹ç‚¹
æ ¹æ®æ‚¨çš„äº”è¡Œé…ç½®ï¼Œæ‚¨çš„ä½“è´¨ç‰¹ç‚¹å¦‚ä¸‹ï¼š

æ‚¨å±äºå${baziData.elements.wood > baziData.elements.fire ? 'æœ¨' : 'ç«'}å‹ä½“è´¨ï¼Œè¿™æ„å‘³ç€æ‚¨çš„æ–°é™ˆä»£è°¢è¾ƒä¸ºæ´»è·ƒï¼Œç²¾åŠ›å……æ²›ï¼Œä½†ä¹Ÿå®¹æ˜“å‡ºç°èƒ½é‡æ¶ˆè€—è¿‡åº¦çš„æƒ…å†µã€‚æ‚¨çš„å…ç–«ç³»ç»Ÿæ•´ä½“è‰¯å¥½ï¼Œä½†éœ€è¦æ³¨æ„å­£èŠ‚å˜åŒ–å¯¹èº«ä½“çš„å½±å“ã€‚

## éœ€è¦å…³æ³¨çš„å¥åº·é¢†åŸŸ
1. **ç¥ç»ç³»ç»Ÿ**ï¼šç”±äºæ€è™‘è¾ƒå¤šï¼Œéœ€è¦æ³¨æ„ç¥ç»ç³»ç»Ÿçš„ä¿å…»
2. **æ¶ˆåŒ–ç³»ç»Ÿ**ï¼šæƒ…ç»ªæ³¢åŠ¨å¯èƒ½å½±å“æ¶ˆåŒ–åŠŸèƒ½
3. **ç¡çœ è´¨é‡**ï¼šç¡®ä¿å……è¶³çš„ç¡çœ ï¼Œé¿å…ç†¬å¤œ
4. **çœ¼ç›ä¿æŠ¤**ï¼šé•¿æ—¶é—´ç”¨è„‘ç”¨çœ¼ï¼Œéœ€è¦é€‚å½“ä¼‘æ¯
5. **è„Šæ¤å¥åº·**ï¼šæ³¨æ„åå§¿ï¼Œå®šæœŸæ´»åŠ¨

## å­£èŠ‚æ€§å…»ç”Ÿ
**æ˜¥å­£å…»ç”Ÿ**ï¼š
- å¤šè¿›è¡Œæˆ·å¤–æ´»åŠ¨ï¼Œå‘¼å¸æ–°é²œç©ºæ°”
- é¥®é£Ÿæ¸…æ·¡ï¼Œå¤šåƒç»¿è‰²è”¬èœ
- æ—©ç¡æ—©èµ·ï¼Œé¡ºåº”è‡ªç„¶è§„å¾‹

**å¤å­£å…»ç”Ÿ**ï¼š
- é¿å…è¿‡åº¦è´ªå‡‰ï¼Œä¿æŠ¤é˜³æ°”
- å¤šå–æ°´ï¼Œè¡¥å……æµå¤±çš„æ°´åˆ†
- é€‚å½“åˆä¼‘ï¼Œé¿å…ä¸­æš‘

**ç§‹å­£å…»ç”Ÿ**ï¼š
- æ¶¦è‚ºå…»é˜´ï¼Œå¤šåƒæ¢¨ã€ç™¾åˆç­‰
- æ³¨æ„ä¿æš–ï¼Œé¢„é˜²æ„Ÿå†’
- è°ƒèŠ‚æƒ…ç»ªï¼Œé¿å…æ‚²ç§‹

**å†¬å­£å…»ç”Ÿ**ï¼š
- æ³¨é‡ä¿æš–ï¼Œç‰¹åˆ«æ˜¯è…°éƒ¨å’Œè„šéƒ¨
- é€‚å½“è¿›è¡¥ï¼Œå¢å¼ºä½“è´¨
- å‡å°‘æˆ·å¤–æ´»åŠ¨ï¼Œå‚¨å­˜èƒ½é‡

## è¿åŠ¨ä¸é¥®é£Ÿ
**æ¨èè¿åŠ¨**ï¼š
- ç‘œä¼½ï¼šæœ‰åŠ©äºèº«å¿ƒå¹³è¡¡
- å¤ªææ‹³ï¼šåŠ¨é™ç»“åˆï¼Œå…»ç”Ÿå¥ä½“
- æ…¢è·‘ï¼šå¢å¼ºå¿ƒè‚ºåŠŸèƒ½
- æ¸¸æ³³ï¼šå…¨èº«è¿åŠ¨ï¼Œå‡è½»å…³èŠ‚å‹åŠ›

**é¥®é£Ÿå»ºè®®**ï¼š
- é¥®é£Ÿè§„å¾‹ï¼Œé¿å…æš´é¥®æš´é£Ÿ
- å¤šåƒäº”è°·æ‚ç²®ï¼Œå¹³è¡¡è¥å…»
- é€‚é‡æ‘„å…¥ä¼˜è´¨è›‹ç™½è´¨
- å‡å°‘è¾›è¾£åˆºæ¿€é£Ÿç‰©
- æ ¹æ®å­£èŠ‚è°ƒæ•´é¥®é£Ÿç»“æ„

## å¿ƒç†å¥åº·
1. **å†¥æƒ³ç»ƒä¹ **ï¼šæ¯å¤©10-20åˆ†é’Ÿçš„å†¥æƒ³
2. **æƒ…ç»ªæ—¥è®°**ï¼šè®°å½•å’Œåæ€æƒ…ç»ªå˜åŒ–
3. **ç¤¾äº¤æ´»åŠ¨**ï¼šä¿æŒé€‚åº¦çš„ç¤¾äº¤äº’åŠ¨
4. **å…´è¶£åŸ¹å…»**ï¼šå‘å±•èƒ½å¤Ÿæ”¾æ¾èº«å¿ƒçš„çˆ±å¥½
5. **ä¸“ä¸šå¸®åŠ©**ï¼šå¿…è¦æ—¶å¯»æ±‚å¿ƒç†å’¨è¯¢

---

# å…­ã€ç»¼åˆå»ºè®®ä¸æ€»ç»“

## äººç”Ÿè§„åˆ’å»ºè®®
åŸºäºä»¥ä¸Šå…¨é¢çš„åˆ†æï¼Œä¸ºæ‚¨æä¾›ä»¥ä¸‹ç»¼åˆå»ºè®®ï¼š

1. **å‘æŒ¥ä¼˜åŠ¿**ï¼šå……åˆ†åˆ©ç”¨æ‚¨çš„åˆ›æ–°æ€ç»´å’Œé¢†å¯¼æ‰èƒ½
2. **è¡¥è¶³çŸ­æ¿**ï¼šæ”¹å–„æ—¶é—´ç®¡ç†å’Œæƒ…ç»ªæ§åˆ¶èƒ½åŠ›
3. **æŒç»­æˆé•¿**ï¼šä¿æŒå­¦ä¹ çš„çƒ­æƒ…å’Œå¼€æ”¾çš„å¿ƒæ€
4. **å¹³è¡¡ç”Ÿæ´»**ï¼šåœ¨äº‹ä¸šã€å®¶åº­ã€å¥åº·å’Œç²¾ç¥è¿½æ±‚ä¹‹é—´æ‰¾åˆ°å¹³è¡¡
5. **æœåŠ¡ä»–äºº**ï¼šç”¨æ‚¨çš„æ‰èƒ½å’Œæ™ºæ…§å¸®åŠ©æ›´å¤šçš„äºº

## è¿‘æœŸå‘å±•é‡ç‚¹
åœ¨æœªæ¥1-2å¹´å†…ï¼Œå»ºè®®æ‚¨é‡ç‚¹å…³æ³¨ï¼š

1. **æŠ€èƒ½æå‡**ï¼šé€‰æ‹©1-2é¡¹æ ¸å¿ƒæŠ€èƒ½æ·±å…¥å­¦ä¹ 
2. **äººè„‰æ‹“å±•**ï¼šå»ºç«‹é«˜è´¨é‡çš„èŒä¸šå’Œç¤¾äº¤ç½‘ç»œ
3. **å¥åº·ç®¡ç†**ï¼šå»ºç«‹è§„å¾‹çš„è¿åŠ¨å’Œä½œæ¯ä¹ æƒ¯
4. **è´¢åŠ¡è§„åˆ’**ï¼šåˆ¶å®šåˆç†çš„å‚¨è“„å’ŒæŠ•èµ„è®¡åˆ’
5. **å®¶åº­å…³ç³»**ï¼šå¤šèŠ±æ—¶é—´é™ªä¼´å®¶äººï¼Œå¢è¿›æ„Ÿæƒ…

## é•¿æœŸå‘å±•ç›®æ ‡
3-5å¹´çš„é•¿æœŸç›®æ ‡å»ºè®®ï¼š

1. **äº‹ä¸šç›®æ ‡**ï¼šåœ¨ä¸“ä¸šé¢†åŸŸå»ºç«‹æƒå¨åœ°ä½
2. **è´¢åŠ¡ç›®æ ‡**ï¼šå®ç°è´¢åŠ¡è‡ªç”±çš„åŸºç¡€
3. **å®¶åº­ç›®æ ‡**ï¼šåˆ›é€ å’Œè°å¹¸ç¦çš„å®¶åº­ç¯å¢ƒ
4. **ä¸ªäººæˆé•¿**ï¼šå®Œæˆé‡è¦çš„è‡ªæˆ‘çªç ´å’Œè½¬å‹
5. **ç¤¾ä¼šè´¡çŒ®**ï¼šæ‰¾åˆ°å›é¦ˆç¤¾ä¼šçš„æ–¹å¼

---

## ç»“è¯­

æ¯ä¸ªäººéƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„å­˜åœ¨ï¼Œæ‚¨çš„å…«å­—å‘½ç†åªæ˜¯äº†è§£è‡ªå·±çš„ä¸€ä¸ªè§’åº¦ã€‚çœŸæ­£çš„å‘½è¿æŒæ¡åœ¨æ‚¨è‡ªå·±æ‰‹ä¸­ã€‚å¸Œæœ›è¿™ä»½æŠ¥å‘Šèƒ½å¤Ÿä¸ºæ‚¨æä¾›æœ‰ä»·å€¼çš„å‚è€ƒå’ŒæŒ‡å¯¼ï¼Œå¸®åŠ©æ‚¨æ›´å¥½åœ°è®¤è¯†è‡ªå·±ï¼Œè§„åˆ’æœªæ¥ï¼Œå®ç°äººç”Ÿçš„ç¾å¥½æ„¿æ™¯ã€‚

è®°ä½ï¼šå‘½ç†åˆ†ææ˜¯æŒ‡å—é’ˆï¼Œè€Œä¸æ˜¯åœ°å›¾ã€‚æ‚¨çš„é€‰æ‹©å’ŒåŠªåŠ›æ‰æ˜¯å†³å®šäººç”Ÿæ–¹å‘çš„å…³é”®ã€‚æ„¿æ‚¨åœ¨äººç”Ÿçš„é“è·¯ä¸Šï¼Œå‹‡æ•¢å‰è¡Œï¼Œæ™ºæ…§é€‰æ‹©ï¼Œæ”¶è·å¹¸ç¦ä¸æˆåŠŸï¼

---

*æœ¬æŠ¥å‘ŠåŸºäºä¸­å›½ä¼ ç»Ÿå‘½ç†å­¦åŸç†ï¼Œç»“åˆç°ä»£å¿ƒç†å­¦å’Œç”Ÿæ¶¯è§„åˆ’ç†è®ºç”Ÿæˆã€‚å»ºè®®ä»…ä¾›å‚è€ƒï¼Œå…·ä½“å†³ç­–è¯·ç»“åˆå®é™…æƒ…å†µã€‚*`;
}

export async function POST(request: NextRequest) {
  const isStaticMode = process.env.DEPLOYMENT_MODE === 'static'
  
  if (isStaticMode) {
    return NextResponse.json({ 
      error: 'API disabled for static deployment',
      message: 'This is a static demo version. All API endpoints are disabled.',
      status: 'demo_mode'
    }, { status: 503 })
  }

  // åŠ¨æ€æ¨¡å¼ä¸‹çš„æ­£å¸¸APIé€»è¾‘
  try {
    const body = await request.json()
    const { birthData, reportName } = body

    console.log('ğŸš€ [API] Starting report generation with birthData:', birthData)

    // æ£€æŸ¥æ™ºè°±AI APIå¯†é’¥
    if (!process.env.ZHIPU_API_KEY) {
      console.warn('âš ï¸ [API] ZHIPU_API_KEY not found, falling back to mock reports')
      return generateMockReports(birthData, reportName)
    }

    try {
      // è®¡ç®—å…«å­—æ•°æ®
      console.log('ğŸ”® [API] Calculating Bazi data...')
      const baziData = await BaziService.calculateBazi(birthData)
      console.log('âœ… [API] Bazi data calculated successfully')

      // ä½¿ç”¨æ™ºè°±AIç”ŸæˆæŠ¥å‘Š
      console.log('ğŸ¤– [API] Generating AI report with ZhipuAI...')
      const zhipuService = new ZhipuService()
      
      // ç”Ÿæˆå®Œæ•´æŠ¥å‘Š
      const fullReport = await zhipuService.generateBaziReport(birthData, baziData)
      console.log('âœ… [API] Full AI report generated, length:', fullReport.length)
      
      // ä»å®Œæ•´æŠ¥å‘Šä¸­æˆªå–é¢„è§ˆç‰ˆï¼ˆå‰1500å­—ç¬¦ï¼‰
      const previewReport = extractPreviewFromFullReport(fullReport)
      console.log('âœ… [API] Preview report extracted, length:', previewReport.length)
      
      // ç”ŸæˆæŠ¥å‘ŠID
      const reportId = `report-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
      
      return NextResponse.json({
        success: true,
        reportId,
        previewReport,
        fullReport,
        message: 'AIæŠ¥å‘Šç”ŸæˆæˆåŠŸ',
        source: 'zhipu-ai'
      })

    } catch (aiError) {
      console.error('âŒ [API] AI generation failed, falling back to mock reports:', aiError)
      return generateMockReports(birthData, reportName)
    }

  } catch (error) {
    console.error('âŒ [API] Error generating report:', error)
    return NextResponse.json({
      error: 'Failed to generate report',
      message: 'æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
      details: error instanceof Error ? error.message : 'Unknown error'
    }, { status: 500 })
  }
}

// ç”Ÿæˆæ¨¡æ‹ŸæŠ¥å‘Šçš„å‡½æ•°ï¼ˆä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼‰
function generateMockReports(birthData: any, reportName: string) {
  console.log('ğŸ“ [API] Generating mock reports as fallback...')
  
  // Generate mock reports (no Bazi calculation needed for API)
  const mockBaziData = {
    dayMaster: 'ç”²',
    heavenlyStems: ['ç”²', 'ä¹™', 'ä¸™', 'ä¸'],
    earthlyBranches: ['å­', 'ä¸‘', 'å¯…', 'å¯'],
    elements: { wood: 2, fire: 1, earth: 1, metal: 1, water: 1 }
  }
  const fullReport = generateMockReport(birthData, mockBaziData)
  const previewReport = generateMockPreviewReport(birthData, mockBaziData)
  console.log('ğŸ“ [API] Mock reports generated, full length:', fullReport.length, 'preview length:', previewReport.length)
  
  // ç”ŸæˆæŠ¥å‘ŠID
  const reportId = `report-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
  
  return NextResponse.json({
    success: true,
    reportId,
    previewReport,
    fullReport,
    message: 'æ¨¡æ‹ŸæŠ¥å‘Šç”ŸæˆæˆåŠŸ',
    source: 'mock'
  })
}
